# MR2 Misc Firmware

## Overview
This firmware targets an STM32H523 microcontroller and polls a Makita XGT
battery pack over the single-wire diagnostic bus. The battery interface uses a
half-duplex, inverted 9600 baud UART on USART1 while USART2 is reserved for a
115200 baud logging console.【F:Core/Src/battery.c†L1-L39】【F:Core/Src/main.c†L68-L88】【F:Core/Src/main.c†L189-L266】

A cooperative state machine wakes the pack, issues Makita-specific commands, and
parses responses to track charge level, health, temperature, pack voltage, and
per-cell voltages. Results are written to the logging UART so a host can capture
telemetry in real time.【F:Core/Src/battery.c†L230-L451】

## Repository layout
The most relevant top-level files and directories are:

- `Core/` – Application sources and headers generated by STM32CubeMX with the
  custom Makita protocol driver in `Src/battery.c` and its interface in
  `Inc/battery.h`.【F:Core/Src/battery.c†L1-L451】【F:Core/Inc/battery.h†L1-L20】
- `Drivers/` – STM32 HAL and CMSIS dependencies supplied by CubeMX.
- `cmake/` – Toolchain files plus the CubeMX CMake glue that brings in the HAL
  and startup code.【F:CMakeLists.txt†L31-L69】
- `startup_stm32h523xx.s`, `STM32H523xx_*.ld` – Linker scripts and startup
  assembly for the STM32H523 target.
- `mr2_misc_fw.ioc` – CubeMX project file to regenerate peripheral
  configuration.

## Firmware architecture
The firmware is built around a polling loop in `main()` that repeatedly calls
`battery_task()`. `battery_init()` stores the UART handles configured by CubeMX
and arms the update timer. Each trip through `battery_task()` advances a
non-blocking state machine that manages wake-up timing, command dispatch, and
response parsing so the MCU can remain responsive without an RTOS.【F:Core/Src/main.c†L68-L88】【F:Core/Src/battery.c†L230-L451】

Key protocol details include:

- Half-duplex UART transactions with explicit transmitter/receiver toggling to
  share the single diagnostic wire.【F:Core/Src/battery.c†L144-L228】
- Bit-reversal of received bytes and Makita-specific CRC validation to decode
  the pack’s response format.【F:Core/Src/battery.c†L41-L142】
- Periodic polling (default 10 s) of pack metadata, aggregate measurements, and
  individual cell voltages; a rolling summary is printed after each full
  cycle.【F:Core/Src/battery.c†L22-L39】【F:Core/Src/battery.c†L275-L451】

## Hardware connections
CubeMX configures the UART pins as follows (see `stm32h5xx_hal_msp.c`):

- PB14 → `USART1_TX` configured for half-duplex mode and level inversion; tie
  this pin to the Makita battery bus through appropriate level shifting and
  protection. Reception reuses the same pin because of the half-duplex
  configuration.【F:Core/Src/stm32h5xx_hal_msp.c†L83-L158】【F:Core/Src/main.c†L189-L218】
- PA2/PA3 → `USART2_TX/RX` for the 115200 baud logging console; connect to a USB
  UART bridge for monitoring.【F:Core/Src/stm32h5xx_hal_msp.c†L123-L200】【F:Core/Src/main.c†L228-L266】

Make sure the STM32 ground is common with the battery pack ground and add
appropriate protection circuitry before attaching an actual pack.

## Building the project
The project uses CMake with presets tailored for the ARM GCC toolchain. Install
`gcc-arm-none-eabi`, CMake ≥3.22, and Ninja (or adjust the presets as needed).
The default toolchain file lives in `cmake/gcc-arm-none-eabi.cmake` and is
selected automatically by the presets.【F:CMakePresets.json†L1-L34】

Example build workflow:

```sh
cmake --preset Debug
cmake --build --preset Debug
```

The resulting `mr2_misc_fw.elf` binary will be placed under
`build/Debug/`. To produce an optimized build, substitute the `Release`
preset.【F:CMakePresets.json†L14-L34】

## Flashing and debugging
Use your preferred STM32 programming tool (e.g. STM32CubeProgrammer, OpenOCD,
or pyOCD) to flash the generated ELF or HEX image to the target. When using
OpenOCD, point it at the board-specific configuration and load the
`mr2_misc_fw.elf` from the chosen build directory.

## Logging and telemetry
Attach a 3.3 V USB-to-UART adapter to USART2 (PA2/PA3) at 115200 baud, 8 data
bits, no parity, 1 stop bit. The firmware prints command traces and a summary of
the latest pack data after each polling cycle. You can adjust the verbosity by
changing `XGT_DBG` in `Core/Src/battery.c`.

## Customisation
- Polling interval: tweak `s_update_interval_ms` in `battery.c` to change how
  often a new cycle runs (default 10 s).【F:Core/Src/battery.c†L22-L39】
- Command set: extend the `CMD_*` arrays and state machine cases to query other
  Makita registers.【F:Core/Src/battery.c†L55-L451】
- Logging UART: adapt `battery_init()` to redirect logs to a different
  peripheral or disable them entirely.【F:Core/Src/battery.c†L259-L451】

## Regenerating code with CubeMX
Opening `mr2_misc_fw.ioc` in STM32CubeMX lets you inspect or modify peripheral
settings. After saving from CubeMX, re-run CMake to rebuild with the updated
HAL-generated sources.

## License
The STM32 HAL files retain the STMicroelectronics license headers generated by
CubeMX. Add project-specific licensing information here if needed.
